@inject NavigationManager NavigationManager

<!-- Footer Navigation - Solo en móvil -->
<footer class="fixed bottom-0 w-full bg-white/95 dark:bg-background-dark/95 backdrop-blur-xl border-t border-slate-200 dark:border-slate-800 px-6 py-2 pb-8 z-50 md:hidden">
    <div class="flex justify-between items-center max-w-md mx-auto">
        <a class="flex flex-col items-center gap-1 @GetNavItemClass("cofradia")" href="#" @onclick="NavigateToCofradia" @onclick:preventDefault>
            <span class="material-symbols-outlined text-[26px]">grid_view</span>
            <span class="text-[10px] font-bold">Panel</span>
        </a>
@*         <a class="flex flex-col items-center gap-1 @GetNavItemClass("empresas")" href="#" @onclick="NavigateToEmpresas" @onclick:preventDefault>
            <span class="material-symbols-outlined text-[26px]">corporate_fare</span>
            <span class="text-[10px] font-medium">Empresas</span>
        </a> *@
        <a class="flex flex-col items-center gap-1 @GetNavItemClass("barcos")" href="#" @onclick="NavigateToBuques" @onclick:preventDefault>
            <span class="material-symbols-outlined text-[26px]">directions_boat</span>
            <span class="text-[10px] font-medium">Centros de trabajo</span>
        </a>
        <a class="flex flex-col items-center gap-1 @GetNavItemClass("tramites-masivos")" href="#" @onclick="NavigateToTramitesMasivos" @onclick:preventDefault>
            <span class="material-symbols-outlined text-[26px]">dynamic_feed</span>
            <span class="text-[10px] font-medium">Masivos</span>
        </a>
    </div>
</footer>

@using Microsoft.AspNetCore.Components.Authorization
@using CRM.V3.Shared.Interfaces
@using CRM.Dtos
@inject AuthenticationStateProvider AuthStateProvider
@inject ICurrentUserService CurrentUserService

@code {
    private string currentRoute = "/";
    private bool showAdminOptions = false;

    protected override async Task OnInitializedAsync()
    {
        currentRoute = NavigationManager.ToBaseRelativePath(NavigationManager.Uri);
        NavigationManager.LocationChanged += OnLocationChanged;
        await CheckUserRole();
    }

    private async Task CheckUserRole()
    {
        try
        {
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;
            
            if (user.Identity?.IsAuthenticated == true)
            {
                var currentUser = await CurrentUserService.GetCurrentUserAsync(user);
                
                if (currentUser != null && !string.IsNullOrEmpty(currentUser.Rol))
                {
                    showAdminOptions = currentUser.Rol.Equals("Administrador", StringComparison.OrdinalIgnoreCase);
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error checking user role: {ex.Message}");
        }
    }

    private void OnLocationChanged(object? sender, Microsoft.AspNetCore.Components.Routing.LocationChangedEventArgs e)
    {
        currentRoute = NavigationManager.ToBaseRelativePath(e.Location);
        StateHasChanged();
    }

    private void Navigate(string route)
    {
        NavigationManager.NavigateTo(route);
    }

    private void NavigateToCofradia() => Navigate("");
    private void NavigateToEmpresas() => Navigate("/empresas");
    private void NavigateToBuques() => Navigate("barcos");
    private void NavigateToTramitesMasivos() => Navigate("/tramites-masivos");

    private string GetNavItemClass(string route)
    {
        return currentRoute.StartsWith(route.TrimStart('/')) 
            ? "text-primary" 
            : "text-slate-400 dark:text-slate-500";
    }

    public void Dispose()
    {
        NavigationManager.LocationChanged -= OnLocationChanged;
    }
}
