@using Microsoft.AspNetCore.Components.Authorization
@using CRM.V3.Shared.Interfaces
@using CRM.Dtos
@using System.Security.Claims
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthStateProvider
@inject IAuthService AuthService
@inject ICurrentUserService CurrentUserService
@inject IPlatformNavigationService PlatformNavigation

<!-- Header -->
<header class="w-full sticky top-0 z-40 bg-background-light/80 dark:bg-background-dark/80 backdrop-blur-md border-b border-slate-200 dark:border-slate-800">
    <div class="w-full">
        <div class="flex items-center justify-between px-4 md:px-6 lg:px-8 h-16 md:h-20">
            <button class="p-2 text-slate-700 dark:text-slate-300 md:hidden" 
            @onclick="ToggleMobileMenu">
                <span class="material-symbols-outlined">menu</span>
            </button>
            
            <!-- Logo/Título - Mejorado para desktop -->
            <div class="flex items-center gap-3">
                <div class="hidden md:flex bg-primary text-white p-2 rounded-xl cursor-pointer" @onclick="NavigateToHome">
                    <span class="material-symbols-outlined text-2xl">sailing</span>
                </div>
                <div class="flex flex-col cursor-pointer" @onclick="NavigateToHome">
                    <h1 class="text-base md:text-xl lg:text-2xl font-bold tracking-tight">@headerTitle</h1>
                    <p class="text-[10px] md:text-xs text-slate-500 font-medium">@headerSubtitle</p>
                </div>
            </div>

            <!-- Acciones del header -->
            <div class="flex items-center gap-2 md:gap-4">
                <!-- Navegación desktop -->
                <nav class="hidden md:flex items-center gap-1 mr-4">
                    <a href="#" @onclick="NavigateToCofradia" @onclick:preventDefault 
                       class="px-4 py-2 rounded-lg text-sm font-medium transition-colors @GetNavClass("cofradia")">
                        Panel
                    </a>
@*                     <a href="#" @onclick="NavigateToEmpresas" @onclick:preventDefault 
                       class="px-4 py-2 rounded-lg text-sm font-medium transition-colors @GetNavClass("empresas")">
                        Empresas
                    </a> *@
                    <a href="#" @onclick="NavigateToBuques" @onclick:preventDefault 
                       class="px-4 py-2 rounded-lg text-sm font-medium transition-colors @GetNavClass("barcos")">
                        Centros de trabajo
                    </a>
                    <a href="#" @onclick="NavigateToTramitesMasivos" @onclick:preventDefault 
                       class="px-4 py-2 rounded-lg text-sm font-medium transition-colors @GetNavClass("tramites-masivos")">
                        Trámites Masivos
                    </a>
                    @if (showConfigOption)
                    {
                        <a href="#" @onclick="NavigateToUsuarios" @onclick:preventDefault 
                           class="px-4 py-2 rounded-lg text-sm font-medium transition-colors @GetNavClass("usuarios")">
                            Usuarios
                        </a>
                    }
                </nav>

                <button class="p-2 text-slate-700 dark:text-slate-300 relative hover:bg-slate-100 dark:hover:bg-slate-800 rounded-lg transition-colors" @onclick="NavigateToNotificaciones">
                    <span class="material-symbols-outlined">notifications</span>
                    @if (notificationCount > 0)
                    {
                        <span class="absolute top-2 right-2 w-2 h-2 bg-rose-500 rounded-full border-2 border-white dark:border-background-dark"></span>
                    }
                </button>
                
                @if (showConfigOption)
                {
                    <button class="p-2 text-slate-700 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-lg transition-colors" @onclick="NavigateToConfiguracion" title="Configuración">
                        <span class="material-symbols-outlined">settings</span>
                    </button>
                }
                
                <div class="w-8 h-8 md:w-10 md:h-10 rounded-full bg-primary flex items-center justify-center text-white cursor-pointer hover:bg-primary/90 transition-colors" @onclick="NavigateToPerfil">
                    <span class="material-symbols-outlined text-sm md:text-base">admin_panel_settings</span>
                </div>
                
                <button class="p-2 text-slate-700 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-lg transition-colors" @onclick="HandleLogout" title="Cerrar sesión">
                    <span class="material-symbols-outlined">logout</span>
                </button>
            </div>
        </div>
    </div>
</header>

@code {
    [Parameter] public EventCallback OnToggleMobileMenu { get; set; }
    
    private int notificationCount = 3;
    private string currentRoute = "/";
    private bool showConfigOption = false;
    private UsuarioDto? currentUser;
    private string headerTitle = "Panel de Cofradía";
    private string headerSubtitle = "Gestión Multi-empresa";

    protected override async Task OnInitializedAsync()
    {
        currentRoute = NavigationManager.ToBaseRelativePath(NavigationManager.Uri);
        NavigationManager.LocationChanged += OnLocationChanged;
        
        await CheckUserRole();
    }

    private async Task CheckUserRole()
    {
        try
        {
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;
            
            if (user.Identity?.IsAuthenticated == true)
            {
                currentUser = await CurrentUserService.GetCurrentUserAsync(user);
                
                if (currentUser != null)
                {
                    // Show configuration option only for Gestoria or Administrador roles
                    if (!string.IsNullOrEmpty(currentUser.Rol))
                    {
                        showConfigOption = currentUser.Rol.Equals("Gestoria", StringComparison.OrdinalIgnoreCase) 
                                        || currentUser.Rol.Equals("Administrador", StringComparison.OrdinalIgnoreCase);
                    }

                    // Update header title based on user type and company
                    if (!string.IsNullOrEmpty(currentUser.CodigoEmpresa) && currentUser.Empresa != null)
                    {
                        // User is associated with a company
                        var companyName = currentUser.Empresa.NombreArmador ?? currentUser.CodigoEmpresa;
                        headerTitle = $"Panel de {companyName}";
                        
                        // Show username in subtitle
                        var userName = !string.IsNullOrEmpty(currentUser.NombreUsuario) 
                            ? currentUser.NombreUsuario 
                            : (!string.IsNullOrEmpty(currentUser.Nombre) 
                                ? $"{currentUser.Nombre} {currentUser.Apellidos}".Trim() 
                                : currentUser.EMail);
                        headerSubtitle = userName;
                    }
                    else
                    {
                        // Default header for users without company
                        headerTitle = "Panel de Cofradía";
                        headerSubtitle = "Gestión Multi-empresa";
                    }
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error checking user role: {ex.Message}");
        }
    }

    private void OnLocationChanged(object? sender, Microsoft.AspNetCore.Components.Routing.LocationChangedEventArgs e)
    {
        currentRoute = NavigationManager.ToBaseRelativePath(e.Location);
        StateHasChanged();
    }

    private void ToggleMobileMenu()
    {
        OnToggleMobileMenu.InvokeAsync();
    }

    private void Navigate(string route)
    {
        NavigationManager.NavigateTo(route);
    }

    private void NavigateToHome() => Navigate("/");
    private void NavigateToCofradia() => Navigate("cofradia");
    private void NavigateToEmpresas() => Navigate("empresas");
    private void NavigateToBuques() => Navigate("barcos");
    private void NavigateToTramitesMasivos() => Navigate("tramites");
    private void NavigateToNotificaciones() => Navigate("notificaciones");
    private void NavigateToPerfil() => Navigate("perfil");
    private void NavigateToConfiguracion() => Navigate("configuracion");
    private void NavigateToUsuarios() => Navigate("usuarios");

    private async Task HandleLogout()
    {
        try
        {
            await AuthService.LogoutAsync();
            await PlatformNavigation.NavigateToAsync("/login");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error during logout: {ex.Message}");
        }
    }

    private string GetNavClass(string route)
    {
        //return currentRoute.StartsWith(route.TrimStart('/')) 
        //    ? "bg-primary/10 text-primary" 
        //    : "text-slate-600 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-800";
        return "";
    }

    public void Dispose()
    {
        NavigationManager.LocationChanged -= OnLocationChanged;
    }
}
