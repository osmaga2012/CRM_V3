@page "/"
@* @attribute [Authorize] *@
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthStateProvider
@using CRM.Dtos
@using CRM.V3.Shared.Interfaces
@inject IApiClient<EmpresasDto> servicioEmpresas
@inject IApiClient<BarcosDto> servicioBarcos
@inject IApiClient<BarcosTramitesDto> servicioBarcosTramites
@inject IApiClient<UsuarioDto> servicioUsuarios
@inject ICurrentUserService CurrentUserService

@*
    PANEL DE CONTROL - COFRADÍA
    ============================
    
    Modelo de Datos:
    - Los trámites (BarcosTramitesDto) NO tienen campo "Estado" en la base de datos
    - La clasificación de trámites se realiza en tiempo real basándose en fechas:
      * Vigentes: FechaFin > Hoy
      * Por Vencer: FechaFin entre Hoy y 30 días
      * Vencidos: FechaFin <= Hoy
    
    Sistema de Avisos:
    - Los avisos son notificaciones por EMAIL que se envían a los barcos
    - Se programan mediante el campo FechaAviso en BarcosTramitesDto
    - Los emails destinatarios se almacenan en ListaEmailsEnvioAviso
    - NO existe un sistema de estados de trámites, solo gestión por fechas y notificaciones
    
    Contador de Trámites:
    - El total de trámites se obtiene sumando BarcosTramites de todos los barcos
    - BarcosTramites es una colección (ICollection<BarcosTramitesDto>) en BarcosDto
*@

<PageTitle>Panel de Control: Cofradía</PageTitle>

<!-- Main Content -->
<div class="w-full">
    <!-- Stats Cards -->
    <div class="p-4 md:p-6 lg:p-8 grid grid-cols-2 md:grid-cols-4 gap-3 md:gap-4 lg:gap-6">
        <!-- Total Empresas -->
        <div class="col-span-1 flex flex-col gap-1 rounded-2xl p-4 md:p-6 border border-slate-200 dark:border-slate-800 bg-gradient-to-br from-white to-slate-50 dark:from-slate-900 dark:to-slate-800 shadow-sm hover:shadow-xl transition-all duration-300 hover:scale-105">
            <div class="flex items-center justify-between">
                <div class="bg-gradient-to-br from-sky-500 to-blue-600 p-3 rounded-xl shadow-lg">
                    <span class="material-symbols-outlined text-white text-2xl md:text-3xl">corporate_fare</span>
                </div>
                @if (empresasNuevas > 0)
                {
                    <span class="text-[10px] md:text-xs font-bold text-emerald-500 bg-emerald-50 px-2 py-1 rounded-full">+@empresasNuevas</span>
                }
            </div>
            <p class="text-slate-500 dark:text-slate-400 text-[10px] md:text-xs font-bold uppercase tracking-wider mt-3">Empresas Totales</p>
            <p class="text-slate-900 dark:text-white text-2xl md:text-3xl lg:text-4xl font-bold">@totalEmpresas</p>
            <div class="w-full h-1 bg-slate-200 dark:bg-slate-700 rounded-full mt-2 overflow-hidden">
                <div class="h-full bg-gradient-to-r from-sky-500 to-blue-600 rounded-full animate-pulse" style="width: 100%"></div>
            </div>
        </div>

        <!-- Total Barcos -->
        <div class="col-span-1 flex flex-col gap-1 rounded-2xl p-4 md:p-6 border border-slate-200 dark:border-slate-800 bg-gradient-to-br from-white to-slate-50 dark:from-slate-900 dark:to-slate-800 shadow-sm hover:shadow-xl transition-all duration-300 hover:scale-105">
            <div class="flex items-center justify-between">
                <div class="bg-gradient-to-br from-emerald-500 to-green-600 p-3 rounded-xl shadow-lg">
                    <span class="material-symbols-outlined text-white text-2xl md:text-3xl">group</span>
                </div>
                @if (usuariosNuevos > 0)
                {
                    <span class="text-[10px] md:text-xs font-bold text-emerald-500 bg-emerald-50 px-2 py-1 rounded-full">+@usuariosNuevos</span>
                }
            </div>
            <p class="text-slate-500 dark:text-slate-400 text-[10px] md:text-xs font-bold uppercase tracking-wider mt-3">Usuarios Activos</p>
            <p class="text-slate-900 dark:text-white text-2xl md:text-3xl lg:text-4xl font-bold">@totalUsuarios</p>
            <div class="w-full h-1 bg-slate-200 dark:bg-slate-700 rounded-full mt-2 overflow-hidden">
                <div class="h-full bg-gradient-to-r from-emerald-500 to-green-600 rounded-full animate-pulse" style="width: 100%"></div>
            </div>
        </div>

        <!-- Trámites Activos -->
        <div class="col-span-1 flex flex-col gap-1 rounded-2xl p-4 md:p-6 border border-slate-200 dark:border-slate-800 bg-gradient-to-br from-white to-slate-50 dark:from-slate-900 dark:to-slate-800 shadow-sm hover:shadow-xl transition-all duration-300 hover:scale-105">
            <div class="flex items-center justify-between">
                <div class="bg-gradient-to-br from-amber-500 to-orange-600 p-3 rounded-xl shadow-lg">
                    <span class="material-symbols-outlined text-white text-2xl md:text-3xl">description</span>
                </div>
            </div>
            <p class="text-slate-500 dark:text-slate-400 text-[10px] md:text-xs font-bold uppercase tracking-wider mt-3">Trámites Activos</p>
            <p class="text-slate-900 dark:text-white text-2xl md:text-3xl lg:text-4xl font-bold">@totalTramites</p>
            <div class="w-full h-1 bg-slate-200 dark:bg-slate-700 rounded-full mt-2 overflow-hidden">
                <div class="h-full bg-gradient-to-r from-amber-500 to-orange-600 rounded-full animate-pulse" style="width: 75%"></div>
            </div>
        </div>

        <!-- Avisos Programados -->
        <div class="col-span-1 flex flex-col gap-1 rounded-2xl p-4 md:p-6 border border-slate-200 dark:border-slate-800 bg-gradient-to-br from-white to-slate-50 dark:from-slate-900 dark:to-slate-800 shadow-sm hover:shadow-xl transition-all duration-300 hover:scale-105">
            <div class="flex items-center justify-between">
                <div class="bg-gradient-to-br from-purple-500 to-indigo-600 p-3 rounded-xl shadow-lg">
                    <span class="material-symbols-outlined text-white text-2xl md:text-3xl">notifications_active</span>
                </div>
            </div>
            <p class="text-slate-500 dark:text-slate-400 text-[10px] md:text-xs font-bold uppercase tracking-wider mt-3">Emails Pendientes</p>
            <p class="text-slate-900 dark:text-white text-2xl md:text-3xl lg:text-4xl font-bold">@avisosProximos</p>
            <p class="text-[9px] md:text-[10px] text-slate-400 mt-1">Avisos programados por enviar</p>
            <div class="w-full h-1 bg-slate-200 dark:bg-slate-700 rounded-full mt-2 overflow-hidden">
                <div class="h-full bg-gradient-to-r from-purple-500 to-indigo-600 rounded-full animate-pulse" style="width: 60%"></div>
            </div>
        </div>
    </div>

    <!-- Resumen de Trámites por Barco -->
    <div class="px-4 md:px-6 lg:px-8 mb-6">
        <div class="bg-white dark:bg-slate-900 rounded-2xl border border-slate-200 dark:border-slate-800 p-4 md:p-6 shadow-sm">
            <div class="flex items-center justify-between mb-6">
                <div>
                    <h3 class="text-xs md:text-sm font-bold text-slate-400 uppercase tracking-widest flex items-center gap-2">
                        <span class="material-symbols-outlined text-primary">insights</span>
                        Resumen de Trámites por Fecha
                    </h3>
                    <p class="text-[10px] md:text-xs text-slate-500 mt-1">Clasificación basada en fechas de vencimiento</p>
                </div>
            </div>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="flex flex-col items-center p-4 bg-gradient-to-br from-slate-50 to-slate-100 dark:from-slate-800 dark:to-slate-700 rounded-xl">
                    <span class="text-2xl md:text-3xl font-bold text-slate-900 dark:text-white">@totalTramites</span>
                    <span class="text-[10px] md:text-xs text-slate-500 uppercase mt-1 text-center">Total Registrados</span>
                    <div class="w-full h-1.5 md:h-2 bg-slate-200 dark:bg-slate-600 rounded-full mt-3 overflow-hidden">
                        <div class="bg-slate-500 h-full w-full rounded-full"></div>
                    </div>
                </div>
                <div class="flex flex-col items-center p-4 bg-gradient-to-br from-blue-50 to-blue-100 dark:from-blue-900/30 dark:to-blue-800/30 rounded-xl">
                    <span class="text-2xl md:text-3xl font-bold text-blue-600 dark:text-blue-400">@tramitesVigentes</span>
                    <span class="text-[10px] md:text-xs text-slate-500 uppercase mt-1 text-center">Vigentes Hoy</span>
                    <div class="w-full h-1.5 md:h-2 bg-slate-200 dark:bg-slate-600 rounded-full mt-3 overflow-hidden">
                        <div class="bg-blue-500 h-full rounded-full" style="width: @GetPercentage(tramitesVigentes, totalTramites)%"></div>
                    </div>
                </div>
                <div class="flex flex-col items-center p-4 bg-gradient-to-br from-amber-50 to-amber-100 dark:from-amber-900/30 dark:to-amber-800/30 rounded-xl">
                    <span class="text-2xl md:text-3xl font-bold text-amber-600 dark:text-amber-400">@tramitesPorVencer</span>
                    <span class="text-[10px] md:text-xs text-slate-500 uppercase mt-1 text-center">Vencen en 30 días</span>
                    <div class="w-full h-1.5 md:h-2 bg-slate-200 dark:bg-slate-600 rounded-full mt-3 overflow-hidden">
                        <div class="bg-amber-500 h-full rounded-full" style="width: @GetPercentage(tramitesPorVencer, totalTramites)%"></div>
                    </div>
                </div>
                <div class="flex flex-col items-center p-4 bg-gradient-to-br from-rose-50 to-rose-100 dark:from-rose-900/30 dark:to-rose-800/30 rounded-xl">
                    <span class="text-2xl md:text-3xl font-bold text-rose-600 dark:text-rose-400">@tramitesVencidos</span>
                    <span class="text-[10px] md:text-xs text-slate-500 uppercase mt-1 text-center">Ya Vencidos</span>
                    <div class="w-full h-1.5 md:h-2 bg-slate-200 dark:bg-slate-600 rounded-full mt-3 overflow-hidden">
                        <div class="bg-rose-500 h-full rounded-full" style="width: @GetPercentage(tramitesVencidos, totalTramites)%"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Trámite Masivo -->
    <div class="px-4 md:px-6 lg:px-8 mb-6">
        <div class="bg-gradient-to-br from-primary/5 to-primary/10 dark:from-primary/10 dark:to-primary/20 border-2 border-dashed border-primary/30 rounded-2xl p-5 md:p-6 lg:p-8 hover:border-primary/50 transition-all duration-300">
            <div class="flex items-center gap-3 md:gap-4 mb-3 md:mb-4">
                <div class="bg-gradient-to-br from-primary to-blue-600 text-white p-3 md:p-4 rounded-xl md:rounded-2xl shadow-lg">
                    <span class="material-symbols-outlined text-2xl md:text-3xl">dynamic_feed</span>
                </div>
                <div>
                    <h3 class="font-bold text-base md:text-lg text-slate-900 dark:text-white leading-tight">Trámite Masivo</h3>
                    <p class="text-xs md:text-sm text-slate-500">Crea trámites para múltiples centros de trabajo de forma masiva</p>
                </div>
            </div>
            <button class="w-full bg-gradient-to-r from-primary to-blue-600 hover:from-primary/90 hover:to-blue-600/90 text-white font-bold py-3 md:py-4 rounded-xl shadow-lg hover:shadow-xl transition-all flex items-center justify-center gap-2 hover:scale-105 duration-300" @onclick="IniciarTramiteMasivo">
                <span class="material-symbols-outlined text-lg md:text-xl">bolt</span>
                <span class="text-sm md:text-base">Creación de tramites masivos.</span>
            </button>
        </div>
    </div>

    <!-- Últimas Empresas Registradas -->
    <div class="flex items-center justify-between px-4 md:px-6 lg:px-8 pb-3 md:pb-4">
        <h2 class="text-slate-900 dark:text-white text-lg md:text-xl lg:text-2xl font-bold tracking-tight flex items-center gap-2">
            <span class="material-symbols-outlined text-primary">business</span>
            Empresas Recientes
        </h2>
        <button @onclick='() => NavigationManager.NavigateTo("barcos")' class="text-primary text-xs md:text-sm font-bold uppercase tracking-wide hover:underline flex items-center gap-1">
            Ver Todas
            <span class="material-symbols-outlined text-sm">arrow_forward</span>
        </button>
    </div>

    <div class="px-4 md:px-6 lg:px-8 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 md:gap-4 mb-6">
        @if (empresasRecientes != null && empresasRecientes.Any())
        {
            @foreach (var empresa in empresasRecientes.Take(6))
            {
                <div class="flex items-center gap-4 bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 p-4 md:p-5 rounded-2xl shadow-sm cursor-pointer hover:shadow-xl hover:border-primary/50 hover:scale-105 transition-all duration-300" @onclick="@(() => NavigateToEmpresaDetalle(empresa.CodigoEmpresa))">
                    <div class="bg-gradient-to-br from-primary/10 to-blue-600/10 text-primary shrink-0 w-12 h-12 md:w-14 md:h-14 flex items-center justify-center rounded-xl font-bold text-base md:text-lg shadow-inner">
                        @GetInicialesEmpresa(empresa.NombreArmador)
                    </div>
                    <div class="flex flex-col flex-1 min-w-0">
                        <p class="text-slate-900 dark:text-white text-sm md:text-base font-bold leading-tight truncate">@empresa.NombreArmador</p>
                        <div class="flex items-center gap-3 mt-1">
                            <div class="flex items-center gap-1">
                                <span class="material-symbols-outlined text-[14px] md:text-base text-primary">directions_boat</span>
                                <span class="text-xs md:text-sm text-slate-500">(@empresa.Barco!.CodigoBarco) - @empresa.Barco!.NombreB</span>
                            </div>
                            <div class="flex items-center gap-1">
                                <span class="material-symbols-outlined text-[14px] md:text-base text-slate-400">tag</span>
                                <span class="text-xs md:text-sm text-slate-500 font-mono">@empresa.CodigoEmpresa</span>
                            </div>
                        </div>
                    </div>
                    <span class="material-symbols-outlined text-slate-300 shrink-0">chevron_right</span>
                </div>
            }
        }
        else
        {
            <div class="col-span-full flex flex-col items-center justify-center py-12 text-slate-400">
                <span class="material-symbols-outlined text-6xl mb-3">business_center</span>
                <p class="text-sm">No hay empresas registradas</p>
            </div>
        }
    </div>

    <!-- Próximos Avisos -->
    @if (proximosAvisos != null && proximosAvisos.Any())
    {
        <div class="px-4 md:px-6 lg:px-8 mb-6">
            <div class="flex items-center justify-between mb-4">
                <div>
                    <h2 class="text-slate-900 dark:text-white text-lg md:text-xl lg:text-2xl font-bold tracking-tight flex items-center gap-2">
                        <span class="material-symbols-outlined text-amber-500">schedule</span>
                        Próximos Avisos de Trámites
                    </h2>
                    <p class="text-xs md:text-sm text-slate-500 mt-1">Notificaciones por email programadas para los barcos</p>
                </div>
            </div>
            <div class="bg-white dark:bg-slate-900 rounded-2xl border border-slate-200 dark:border-slate-800 shadow-sm overflow-hidden">
                <div class="divide-y divide-slate-100 dark:divide-slate-800">
                    @foreach (var aviso in proximosAvisos.Take(5))
                    {
                        var diasRestantes = aviso.FechaAviso != default ? (aviso.FechaAviso.ToDateTime(TimeOnly.MinValue) - DateTime.Now).Days : 0;
                        var esUrgente = diasRestantes <= 7;
                        var esProximo = diasRestantes > 7 && diasRestantes <= 30;
                        
                        <div class="p-4 md:p-5 hover:bg-slate-50 dark:hover:bg-slate-800/50 transition-colores">
                            <div class="flex items-start gap-4">
                                @if (esUrgente)
                                {
                                    <div class="bg-rose-50 dark:bg-rose-900/30 text-rose-600 dark:text-rose-400 shrink-0 w-12 h-12 flex flex-col items-center justify-center rounded-xl font-bold">
                                        <span class="text-xs">@aviso.FechaAviso.Day</span>
                                        <span class="text-[10px] uppercase">@((aviso.FechaAviso != default(DateOnly)) ? aviso.FechaAviso.ToString("MMM") : "")</span>
                                    </div>
                                }
                                else if (esProximo)
                                {
                                    <div class="bg-amber-50 dark:bg-amber-900/30 text-amber-600 dark:text-amber-400 shrink-0 w-12 h-12 flex flex-col items-center justify-center rounded-xl font-bold">
                                        <span class="text-xs">@aviso.FechaAviso.Day</span>
                                        <span class="text-[10px] uppercase">@((aviso.FechaAviso != default(DateOnly)) ? aviso.FechaAviso.ToString("MMM") : "")</span>
                                    </div>
                                }
                                else
                                {
                                    <div class="bg-blue-50 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 shrink-0 w-12 h-12 flex flex-col items-center justify-center rounded-xl font-bold">
                                        <span class="text-xs">@aviso.FechaAviso.Day</span>
                                        <span class="text-[10px] uppercase">@aviso.FechaAviso ? aviso.FechaAviso.Value.ToString("MMM") : ""</span>
                                    </div>
                                }
                                
                                <div class="flex-1 min-w-0">
                                    <div class="flex items-start justify-between gap-2">
                                        <div>
                                            <p class="text-sm md:text-base font-bold text-slate-900 dark:text-white">@aviso.Certificado</p>
                                            <p class="text-xs md:text-sm text-slate-500 mt-0.5">Barco: @aviso.CodigoBarco</p>
                                        </div>
                                        @if (esUrgente)
                                        {
                                            <span class="text-[10px] md:text-xs font-bold text-rose-600 dark:text-rose-400 bg-rose-50 dark:bg-rose-900/30 px-2 py-1 rounded-full whitespace-nowrap">
                                                @(diasRestantes > 0 ? $"En {diasRestantes} días" : "HOY")
                                            </span>
                                        }
                                        else if (esProximo)
                                        {
                                            <span class="text-[10px] md:text-xs font-bold text-amber-600 dark:text-amber-400 bg-amber-50 dark:bg-amber-900/30 px-2 py-1 rounded-full whitespace-nowrap">
                                                En @diasRestantes días
                                            </span>
                                        }
                                        else
                                        {
                                            <span class="text-[10px] md:text-xs font-bold text-blue-600 dark:text-blue-400 bg-blue-50 dark:bg-blue-900/30 px-2 py-1 rounded-full whitespace-nowrap">
                                                En @diasRestantes días
                                            </span>
                                        }
                                    </div>
                                    @if (!string.IsNullOrEmpty(aviso.ListaEmailsEnvioAviso))
                                    {
                                        <div class="flex items-center gap-1 mt-2">
                                            <span class="material-symbols-outlined text-xs text-slate-400">mail</span>
                                            <span class="text-[10px] md:text-xs text-slate-400">@aviso.ListaEmailsEnvioAviso.Split(',').Length email(s)</span>
                                        </div>
                                    }
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>
    }
</div>

@code {
    // Propiedades para estadísticas generales
    private int totalEmpresas = 0;
    private int empresasNuevas = 0;
    private int totalUsuarios = 0;
    private int usuariosNuevos = 0;
    
    // Propiedades para trámites (basadas en fechas, NO en estados de BD)
    private int totalTramites = 0;
    private int tramitesVigentes = 0;        // FechaFin > hoy
    private int tramitesPorVencer = 0;       // FechaFin entre hoy y 30 días
    private int tramitesVencidos = 0;        // FechaFin <= hoy
    private int avisosProximos = 0;          // Cantidad de avisos programados próximos

    // Colecciones de datos
    private List<EmpresasDto> empresasRecientes = new();
    private List<BarcosTramitesDto> proximosAvisos = new();
    private bool isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        await CargarDatosPanel();
    }

    private async Task CargarDatosPanel()
    {
        try
        {
            isLoading = true;
            
            // Get current user to apply role-based filtering
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var currentUser = await CurrentUserService.GetCurrentUserAsync(authState.User);
            
            Console.WriteLine($"PanelCofradia: Current user role = {currentUser?.Rol}, CodigoEmpresa = {currentUser?.CodigoEmpresa}");
            
            // Cargar empresas con include de Barco y BarcosTramites
            string[] includesEmpresas = new string[] { "Barco.BarcosTramites" };
            var empresasResult = await servicioEmpresas.GetAllAsync("api/Empresa", null, includesEmpresas);
            var empresas = empresasResult?.ToList() ?? new List<EmpresasDto>();
            
            // Filter by user's company if role is "Empresa"
            if (currentUser?.Rol?.Equals("Empresa", StringComparison.OrdinalIgnoreCase) == true && 
                !string.IsNullOrEmpty(currentUser.CodigoEmpresa))
            {
                empresas = empresas.Where(e => e.CodigoEmpresa == currentUser.CodigoEmpresa).ToList();
                Console.WriteLine($"PanelCofradia: Filtered empresas by CodigoEmpresa = {currentUser.CodigoEmpresa}, count = {empresas.Count}");
            }
            
            totalEmpresas = empresas.Count;
            
            // Calcular empresas nuevas (últimos 30 días)
            // var hace30Dias = DateTime.Now.AddDays(-30);
            // empresasNuevas = empresas.Count(e => e.FechaAlta.HasValue && e.FechaAlta.Value >= hace30Dias);
            
            // // Obtener empresas recientes para mostrar (ordenadas por fecha de creación)
            // empresasRecientes = empresas
            //     .OrderByDescending(e => e.FechaAlta)
            //     .Take(6)
            //     .ToList();

            // Cargar usuarios
            var usuariosResult = await servicioUsuarios.GetAllAsync("api/Usuarios", new Dictionary<string, string>(), Array.Empty<string>());
            var usuarios = usuariosResult?.ToList() ?? new List<UsuarioDto>();
            
            // Filter users by company if role is "Empresa"
            if (currentUser?.Rol?.Equals("Empresa", StringComparison.OrdinalIgnoreCase) == true && 
                !string.IsNullOrEmpty(currentUser.CodigoEmpresa))
            {
                usuarios = usuarios.Where(u => u.CodigoEmpresa == currentUser.CodigoEmpresa).ToList();
                Console.WriteLine($"PanelCofradia: Filtered usuarios by CodigoEmpresa = {currentUser.CodigoEmpresa}, count = {usuarios.Count}");
            }
            
            totalUsuarios = usuarios.Count(u => u.Activo == true); // Solo usuarios activos
            
            // Calcular usuarios nuevos (últimos 30 días)
            //usuariosNuevos = usuarios.Count(u => u.Activo == true && u.FechaRegistro >= hace30Dias);

            // Obtener barcos desde las empresas (ya vienen con el include)
            var barcos = empresas
                .Where(e => e.Barco != null)
                .Select(e => e.Barco!)
                .ToList();
            
            Console.WriteLine($"PanelCofradia: Barcos from empresas = {barcos.Count}");
            
            // Contar total de trámites desde BarcosTramites (colección en BarcosDto)
            totalTramites = barcos.Sum(b => b.BarcosTramites?.Count ?? 0);
            Console.WriteLine($"PanelCofradia: Total tramites = @totalTramites");
            
            // Clasificar trámites por fecha (sin usar estados de BD)
            var hoy = DateTime.Now;
            var en30Dias = DateTime.Now.AddDays(30);
            
            // Obtener todos los trámites de todos los barcos
            var todosTramites = barcos
                .SelectMany(b => b.BarcosTramites ?? new List<BarcosTramitesDto>())
                .ToList();
            
            // Vigentes: Trámites cuya fecha fin es posterior a hoy
            tramitesVigentes = todosTramites.Count(t => t.FechaFin > DateOnly.FromDateTime(hoy));
            
            // Por vencer: Trámites que vencen en los próximos 30 días
            tramitesPorVencer = todosTramites.Count(t => t.FechaFin > DateOnly.FromDateTime(hoy) && t.FechaFin <= DateOnly.FromDateTime(en30Dias));
            
            // Vencidos: Trámites cuya fecha fin ya pasó
            tramitesVencidos = todosTramites.Count(t => t.FechaFin <= DateOnly.FromDateTime(hoy));

            // Obtener próximos avisos (trámites con fecha de aviso próxima)
            // Estos son los avisos que se enviarán por email a los barcos
            proximosAvisos = todosTramites
                .Where(t => t.FechaAviso != default && t.FechaAviso >= DateOnly.FromDateTime(hoy))
                .OrderBy(t => t.FechaAviso)
                .Take(5)
                .ToList();
            
            avisosProximos = todosTramites.Count(t => t.FechaAviso != default && t.FechaAviso >= DateOnly.FromDateTime(hoy));

            isLoading = false;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error al cargar datos del panel: {ex.Message}");
            isLoading = false;
            StateHasChanged();
        }
    }

    private void NavigateToEmpresaDetalle(string? codigoEmpresa)
    {
        if (!string.IsNullOrEmpty(codigoEmpresa))
        {
            NavigationManager.NavigateTo($"/empresa/{codigoEmpresa}");
        }
    }

    private void IniciarTramiteMasivo()
    {
        NavigationManager.NavigateTo("/tramites-masivos");
    }

    private double GetPercentage(int value, int total)
    {
        if (total == 0) return 0;
        return Math.Round((double)value / total * 100, 2);
    }

    private string GetInicialesEmpresa(string? nombreEmpresa)
    {
        if (string.IsNullOrWhiteSpace(nombreEmpresa))
            return "??";

        var palabras = nombreEmpresa.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        
        if (palabras.Length == 1)
            return palabras[0].Substring(0, Math.Min(2, palabras[0].Length)).ToUpper();
        
        return (palabras[0][0].ToString() + palabras[1][0].ToString()).ToUpper();
    }
}
